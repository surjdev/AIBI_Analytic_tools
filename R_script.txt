
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")


BiocManager::install("GEOquery")


BiocManager::install("Biobase")


# --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ---

# ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏Å‡∏µ‡πà‡∏ä‡∏∏‡∏î (‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏∞‡πÑ‡∏î‡πâ list ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß 1)
gset <- getGEO("GSE66360", GSEMatrix = TRUE, AnnotGPL = TRUE)

show(gset)


length(gset)

my_data <- gset[[1]]

pData(my_data)[1:5, ]

ncol(my_data)

outliers <- c("GSM1620857", "GSM1620858", 
              "GSM1620894", "GSM1620899", "GSM1620912", 
              "GSM1620913", "GSM1620872", "GSM1620885", "GSM1620892")

print(paste("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö:", ncol(my_data)))
samples_to_keep <- !(sampleNames(my_data) %in% outliers)
clean_data <- my_data[, samples_to_keep]
print(paste("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö:", ncol(clean_data)))

# ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ limma (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ)
library(limma)

# 1. ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Expression Data) ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å clean_data
ex <- exprs(clean_data)

# 2. ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á Log2 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (RMA ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Log scale)
# ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏ô 50 ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏î‡∏¥‡∏ö‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏ö‡πÉ‡∏™‡πà log2
qx <- as.numeric(quantile(ex, c(0., 0.25, 0.5, 0.75, 0.99, 1.0), na.rm=T))
LogC <- (qx[5] > 100) ||
          (qx[6]-qx[1] > 50 && qx[2] > 0)
if (LogC) { ex[which(ex <= 0)] <- NaN
  ex <- log2(ex)
  print("‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Log2 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (RMA style)") } else {
  print("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Log2 ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°") }

# 3. ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (Normalize Between Arrays)
# [cite_start]‡πÄ‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô [cite: 87]
ex_norm <- normalizeBetweenArrays(ex)

# 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
exprs(clean_data) <- ex_norm

# 5. (QC) ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü Boxplot ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
# ‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡πÜ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡∏Ç‡∏µ‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ú‡πà‡∏≤‡∏ô
boxplot(ex_norm, main="After Normalization (QC)",
        col="skyblue", outline=FALSE, las=2)

# --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° Discovery vs Validation ---

# ‡∏î‡∏π‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
colnames(pData(clean_data))

# ‡∏•‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢ (‡∏õ‡∏Å‡∏ï‡∏¥‡∏°‡∏±‡∏Å‡∏ä‡∏∑‡πà‡∏≠ characteristics_ch1 ‡∏´‡∏£‡∏∑‡∏≠ title)
print("--- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô characteristics_ch1 ---")
head(pData(clean_data)$characteristics_ch1, 10)

print("--- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô source_name_ch1 ---")
head(pData(clean_data)$source_name_ch1, 10)


# --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Step 3: ‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏≤ DEGs (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß) ---

# 1. ‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° Discovery (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
discovery_idx <- grep("discovery", clean_data$"cohort:ch1", ignore.case = TRUE)
discovery_set <- clean_data[, discovery_idx]
print(paste("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ä‡∏∏‡∏î Discovery:", ncol(discovery_set)))

# 2. ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠ (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÅ‡∏Å‡πâ Error)
raw_groups <- discovery_set$"disease_status:ch1"
# ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ "disease_status: " ‡∏ó‡∏¥‡πâ‡∏á
clean_groups <- gsub("disease_status: ", "", raw_groups)
# ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡πÜ "Acute myocardial infarction" ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "AMI"
clean_groups <- gsub("Acute myocardial infarction", "AMI", clean_groups, ignore.case = TRUE)

# ‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏î‡∏π (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà Control ‡∏Å‡∏±‡∏ö AMI)
print("‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß:")
table(clean_groups)

# 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Factor ‡πÅ‡∏•‡∏∞ Design Matrix
groups <- factor(clean_groups, levels = c("Control", "AMI"))
design <- model.matrix(~ 0 + groups)
colnames(design) <- c("Control", "AMI")

# ‡πÄ‡∏ä‡πá‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏Å‡πá‡∏ú‡πà‡∏≤‡∏ô‡∏â‡∏•‡∏∏‡∏¢)
print(paste("Design Rows:", nrow(design)))
print(paste("Data Columns:", ncol(discovery_set)))

# 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤ DEGs
fit <- lmFit(discovery_set, design)
cont.matrix <- makeContrasts(AMI - Control, levels = design)
fit2 <- contrasts.fit(fit, cont.matrix)
fit2 <- eBayes(fit2)

# ‡∏î‡∏∂‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Fold Change > 1, FDR < 0.05)
degs <- topTable(fit2, adjust.method = "fdr", number = Inf, p.value = 0.05, lfc = 1)

# ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
print(paste("‡πÄ‡∏à‡∏≠‡∏¢‡∏µ‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (DEGs) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:", nrow(degs), "‡∏¢‡∏µ‡∏ô"))
head(degs)

# --- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏° (Debug) ---

# 1. ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå disease_status:ch1 ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏ß‡πâ‡∏ö‡πâ‡∏≤‡∏á (‡πÅ‡∏ö‡∏ö‡∏î‡∏¥‡∏ö‡πÜ)
raw_groups <- discovery_set$"disease_status:ch1"

print("--- ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ) ---")
table(raw_groups) # ‡∏î‡∏π‡∏ã‡∏¥‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á (‡πÄ‡∏ä‡πà‡∏ô‡∏°‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà/‡πÄ‡∏•‡πá‡∏Å)

# 2. ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á characteristics_ch1 ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
# (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡πÇ‡∏ä‡∏ß‡πå‡∏ß‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡∏ß‡∏£‡πå‡πÜ)
raw_groups_backup <- discovery_set$characteristics_ch1
print("--- ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á ---")
table(raw_groups_backup)



# --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Step 3 (Final): ‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏≤ DEGs ---

# 1. ‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° Discovery (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
discovery_idx <- grep("discovery", clean_data$"cohort:ch1", ignore.case = TRUE)
discovery_set <- clean_data[, discovery_idx]
print(paste("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ä‡∏∏‡∏î Discovery:", ncol(discovery_set)))

# 2. ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!)
raw_groups <- discovery_set$"disease_status:ch1"

# ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ "disease_status: " ‡∏ó‡∏¥‡πâ‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
clean_groups <- gsub("disease_status: ", "", raw_groups)

# ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô "Myocardial Infarction" ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "AMI" (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
clean_groups <- gsub("Myocardial Infarction", "AMI", clean_groups, ignore.case = TRUE)

# ‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏î‡∏π‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ Control: 20, AMI: 21 ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô 41)
print("‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß:")
table(clean_groups)

# 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Factor ‡πÅ‡∏•‡∏∞ Design Matrix
groups <- factor(clean_groups, levels = c("Control", "AMI"))
design <- model.matrix(~ 0 + groups)
colnames(design) <- c("Control", "AMI")

# ‡πÄ‡∏ä‡πá‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏•‡∏Ç 2 ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ 41)
print(paste("Design Rows:", nrow(design)))
print(paste("Data Columns:", ncol(discovery_set)))

# 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤ DEGs
fit <- lmFit(discovery_set, design)
cont.matrix <- makeContrasts(AMI - Control, levels = design)
fit2 <- contrasts.fit(fit, cont.matrix)
fit2 <- eBayes(fit2)

# ‡∏î‡∏∂‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Fold Change > 1, FDR < 0.05)
degs <- topTable(fit2, adjust.method = "fdr", number = Inf, p.value = 0.05, lfc = 1)

# ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
print(paste("‡πÄ‡∏à‡∏≠‡∏¢‡∏µ‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (DEGs) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:", nrow(degs), "‡∏¢‡∏µ‡∏ô"))
head(degs)

# --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á WGCNA (Force Install) ---

# 1. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ó‡∏µ‡πà WGCNA ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ (‡∏°‡∏±‡∏Å‡∏à‡∏∞ Error ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ç‡∏≤‡∏î‡∏û‡∏ß‡∏Å‡∏ô‡∏µ‡πâ)
BiocManager::install(c("GO.db", "impute", "preprocessCore"))

# 2. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á WGCNA ‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö
BiocManager::install("WGCNA", force = TRUE)

# 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å! ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏°‡∏µ Error)
library(WGCNA)

# --- ‡∏•‡∏≠‡∏á‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ---
allowWGCNAThreads()
datExpr <- t(exprs(discovery_set))

# ‡πÄ‡∏ä‡πá‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô Error ‡πÅ‡∏•‡πâ‡∏ß)
gsg <- goodSamplesGenes(datExpr, verbose = 3)

if (gsg$allOK) {
  print("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥ WGCNA")
} else {
  print("‚ùå ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°")
}


# ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏î‡∏µ ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á
if (!gsg$allOK) {
  # ‡∏•‡∏ö‡∏¢‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢
  if (sum(!gsg$goodGenes) > 0) 
     printFlush(paste("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏¢‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢:", paste(names(datExpr)[!gsg$goodGenes], collapse = ", ")))
  
  # ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if (sum(!gsg$goodSamples) > 0) 
     printFlush(paste("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢:", paste(rownames(datExpr)[!gsg$goodSamples], collapse = ", ")))
  
  # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ï‡πà‡∏Ç‡∏≠‡∏á‡∏î‡∏µ
  datExpr <- datExpr[gsg$goodSamples, gsg$goodGenes]
}

print("‚úÖ ‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢‡∏ï‡πà‡∏≠!")


# --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ WGCNA (‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå) ---

# ‡πÉ‡∏ä‡πâ Power = 6 ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏£‡∏∞‡∏ö‡∏∏
power_val <- 6 

# ‡∏™‡∏±‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Network ‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (One-step construction)
net <- blockwiseModules(datExpr, 
                        power = power_val,
                        TOMType = "unsigned", 
                        minModuleSize = 50,      # ‡πÄ‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏ö‡∏≠‡∏Å 50
                        mergeCutHeight = 0.5,    # ‡πÄ‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏ö‡∏≠‡∏Å 0.5
                        numericLabels = TRUE, 
                        pamRespectsDendro = FALSE,
                        saveTOMs = FALSE,
                        verbose = 3)

# ‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ß‡πà‡∏≤‡πÄ‡∏à‡∏≠‡∏Å‡∏µ‡πà‡∏™‡∏µ (‡∏Å‡∏µ‡πà Module)
print("‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏µ‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏µ (0 ‡∏Ñ‡∏∑‡∏≠‡∏™‡∏µ‡πÄ‡∏ó‡∏≤/‡∏¢‡∏µ‡∏ô‡πÑ‡∏£‡πâ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î):")
table(net$colors)

# ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡πÄ‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå (‡πÄ‡∏ä‡πà‡∏ô turquoise, pink)
moduleLabels <- net$colors
moduleColors <- labels2colors(net$colors)

# ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü Dendrogram ‡∏î‡∏π‡πÄ‡∏•‡πà‡∏ô‡πÜ ‡∏ß‡πà‡∏≤‡∏™‡∏ß‡∏¢‡πÑ‡∏´‡∏°
plotDendroAndColors(net$dendrograms[[1]], moduleColors[net$blockGenes[[1]]],
                    "Module Colors",
                    dendroLabels = FALSE, hang = 0.03,
                    addGuide = TRUE, guideHang = 0.05,
                    main = "Gene Dendrogram and Module Colors")

# --- 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á traits ‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏Å‡πâ Error) ---

# ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏à‡∏≤‡∏Å discovery_set ‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö
raw_groups <- discovery_set$"disease_status:ch1"
# ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô AMI (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏≥ Step 3)
clean_groups_for_trait <- gsub("disease_status: ", "", raw_groups)
clean_groups_for_trait <- gsub("Myocardial Infarction", "AMI", clean_groups_for_trait, ignore.case = TRUE)

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á traits: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô AMI ‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 1, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà (Control) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0
traits <- data.frame(row.names = rownames(datExpr))
traits$AMI_Status <- ifelse(clean_groups_for_trait == "AMI", 1, 0)

print("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á traits ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß")
head(traits) # ‡πÄ‡∏ä‡πá‡∏Å‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÄ‡∏•‡∏Ç 0 ‡∏Å‡∏±‡∏ö 1 ‡πÑ‡∏´‡∏°

# --- 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (Correlation) ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ---

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏µ
MEs0 <- moduleEigengenes(datExpr, moduleColors)$eigengenes
MEs <- orderMEs(MEs0)

# ‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á "‡∏™‡∏µ" ‡∏Å‡∏±‡∏ö "‡πÇ‡∏£‡∏Ñ"
moduleTraitCor <- cor(MEs, traits, use = "p")
moduleTraitPvalue <- corPvalueStudent(moduleTraitCor, nrow(datExpr))

# --- 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏µ‡∏ó‡∏µ‡πà "‡πÉ‡∏ä‡πà" ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ---
result_table <- data.frame(
  Module = substring(rownames(moduleTraitCor), 3), # ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ME ‡∏≠‡∏≠‡∏Å
  Correlation = moduleTraitCor[, "AMI_Status"],
  P_Value = moduleTraitPvalue[, "AMI_Status"]
)

# ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ (Correlation ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å‡∏™‡∏π‡∏á‡πÜ = ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ‡∏°‡∏≤‡∏Å)
result_table <- result_table[order(-result_table$Correlation), ]

print("--- üèÜ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ AMI ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ---")
print(head(result_table, 5))

# --- 5. ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î (Intersection) ‡∏Ç‡∏≠‡∏á‡∏¢‡∏µ‡∏ô (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ) ---

# 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏µ‡∏ô‡∏à‡∏≤‡∏Å WGCNA (‡∏™‡∏µ Yellow + Red)
wgcna_genes <- names(datExpr)[moduleColors %in% c("yellow", "red")]
# ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏õ‡∏¥‡∏î 3 ‡∏ï‡∏±‡∏ß )))
print(paste("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏µ‡∏ô‡πÉ‡∏ô WGCNA (Yellow + Red):", length(wgcna_genes)))

# 2. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏µ‡∏ô‡∏à‡∏≤‡∏Å DEGs
deg_genes <- rownames(degs)
print(paste("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏µ‡∏ô‡πÉ‡∏ô DEGs:", length(deg_genes)))

# 3. ‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô (Intersection)
intersect_genes <- intersect(wgcna_genes, deg_genes)

# ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
print("------------------------------------------------")
print(paste("üèÜ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (Intersection):", length(intersect_genes)))
print("------------------------------------------------")


# --- ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏´‡∏±‡∏™ Probe ID ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏µ‡∏ô (Gene Symbol) ---

# ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á degs ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô "‡∏¢‡∏µ‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≠‡∏ö" (intersect_genes)
# ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏µ‡∏ô (Gene.symbol) ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (Gene.title)
final_candidates <- degs[intersect_genes, c("Gene.symbol", "Gene.title", "logFC", "adj.P.Val")]

# ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á (logFC) ‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏à‡∏µ‡πä‡∏î‡πÜ ‡∏Å‡πà‡∏≠‡∏ô
final_candidates <- final_candidates[order(-final_candidates$logFC), ]

# ‡πÇ‡∏ä‡∏ß‡πå 20 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
print("--- üèÜ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏µ‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≠‡∏ö 20 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å ---")
print(head(final_candidates[, c("Gene.symbol", "logFC")], 20))

# --- ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÑ‡∏´‡∏°? ---
# ‡πÄ‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏à‡∏≠ Hub Genes 6 ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ:
# LILRA1, CCL20, IL1R2, TYROBP, CXCL16, NFKBIA
target_genes <- c("LILRA1", "CCL20", "IL1R2", "TYROBP", "CXCL16", "NFKBIA")

print("--- üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏µ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ ---")
# ‡∏´‡∏≤‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ ‡∏°‡∏µ‡∏¢‡∏µ‡∏ô‡∏û‡∏ß‡∏Å‡∏ô‡∏µ‡πâ‡∏ï‡∏¥‡∏î‡∏°‡∏≤‡πÑ‡∏´‡∏°
matches <- final_candidates[final_candidates$Gene.symbol %in% target_genes, ]

if (nrow(matches) > 0) {
  print("‡πÄ‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß!! üéâ ‡∏¢‡∏µ‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:")
  print(matches[, c("Gene.symbol", "logFC")])
} else {
  print("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ (Symbol) ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ")
}


# --- 6. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI ---

# 1. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à ML (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
if (!require("glmnet")) install.packages("glmnet")
if (!require("randomForest")) install.packages("randomForest")
if (!require("caret")) install.packages("caret") # ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SVM

library(glmnet)
library(randomForest)
library(caret)

# 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (X) ‡πÅ‡∏•‡∏∞‡πÄ‡∏â‡∏•‡∏¢ (Y)
# ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏¢‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≠‡∏ö (Intersect Genes) ‡∏°‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
x_data <- t(exprs(discovery_set)[intersect_genes, ])
y_data <- as.factor(clean_groups) # Control vs AMI

print("‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô...")

# --- AI ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 1: LASSO Regression ---
print("ü§ñ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô LASSO...")
set.seed(123) # ‡∏•‡πá‡∏≠‡∏Å‡∏ú‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á

# ‡πÅ‡∏õ‡∏•‡∏á Y ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (AMI=1, Control=0) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LASSO
y_lasso <- ifelse(y_data == "AMI", 1, 0)

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏• LASSO
cv_lasso <- cv.glmnet(as.matrix(x_data), y_lasso, family = "binomial", alpha = 1)

# ‡∏î‡∏π‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏µ‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Lambda Minimum)
best_lambda <- cv_lasso$lambda.min
lasso_coef <- coef(cv_lasso, s = best_lambda)

# ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏µ‡∏ô‡∏ó‡∏µ‡πà LASSO ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 0)
lasso_genes_ids <- rownames(lasso_coef)[lasso_coef[,1] != 0]
lasso_genes_ids <- lasso_genes_ids[lasso_genes_ids != "(Intercept)"] # ‡∏ï‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å

# ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏µ‡∏ô
lasso_gene_names <- degs[lasso_genes_ids, "Gene.symbol"]
print(paste("‚úÖ LASSO ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡πÑ‡∏î‡πâ:", length(lasso_gene_names), "‡∏¢‡∏µ‡∏ô"))
print(head(lasso_gene_names))

# --- AI ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 2: Random Forest ---
print("üå≤ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô Random Forest (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)...")
set.seed(123)

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏• RF
rf_model <- randomForest(x_data, y_data, ntree = 500, importance = TRUE)

# ‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏¢‡∏µ‡∏ô (MeanDecreaseGini)
importance_df <- as.data.frame(importance(rf_model))
importance_df$GeneID <- rownames(importance_df)

# ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å -> ‡∏ô‡πâ‡∏≠‡∏¢
importance_df <- importance_df[order(-importance_df$MeanDecreaseAccuracy), ]

# ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Top 30 ‡∏¢‡∏µ‡∏ô‡πÅ‡∏£‡∏Å
top_rf_ids <- head(importance_df$GeneID, 30)
rf_gene_names <- degs[top_rf_ids, "Gene.symbol"]

print(paste("‚úÖ Random Forest Top 30 ‡∏¢‡∏µ‡∏ô‡πÅ‡∏£‡∏Å:"))
print(head(rf_gene_names))

# --- ‡∏™‡∏£‡∏∏‡∏õ: ‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà AI ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ---
final_hub_candidates <- intersect(lasso_gene_names, rf_gene_names)

print("----------------------------------------------------")
print("üèÜ ‡∏¢‡∏µ‡∏ô‡∏ó‡∏µ‡πà AI ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÇ‡∏´‡∏ß‡∏ï‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (Hub Genes):")
print("----------------------------------------------------")
print(final_hub_candidates)


# --- 1. ‡πÅ‡∏Å‡πâ Error: ‡∏•‡∏á‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à kernlab ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô ---
if (!require("kernlab")) install.packages("kernlab")
library(kernlab)
library(caret)
library(e1071)

# --- 2. ‡∏£‡∏±‡∏ô SVM-RFE ‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö (‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏â‡∏•‡∏∏‡∏¢) ---
print("üê¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô SVM-RFE (‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö)...")
set.seed(123)

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Cross-Validation 10 ‡∏£‡∏≠‡∏ö
control <- rfeControl(functions = caretFuncs, method = "cv", number = 10)

# ‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô RFE (‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏¢‡∏µ‡∏ô‡πÑ‡∏´‡∏ô‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏ô‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏™‡∏∏‡∏î)
svm_profile <- rfe(x_data, y_data,
                   sizes = c(1:40),
                   rfeControl = control,
                   method = "svmRadial")

# ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏µ‡∏ô‡∏ó‡∏µ‡πà SVM ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
svm_genes_ids <- predictors(svm_profile)
svm_gene_names <- degs[svm_genes_ids, "Gene.symbol"]

print(paste("‚úÖ SVM-RFE ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡πÑ‡∏î‡πâ:", length(svm_gene_names), "‡∏¢‡∏µ‡∏ô"))
print(head(svm_gene_names))

# --- 3. üèÜ ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏£‡∏≠‡∏ö Final (Intersect 3 AI) ---
final_hub_genes <- intersect(lasso_gene_names, rf_gene_names)
final_hub_genes <- intersect(final_hub_genes, svm_gene_names)

print("----------------------------------------------------")
print("üéâüéâ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏µ‡∏ô Final Hub Genes (‡∏ó‡∏µ‡πà AI 3 ‡∏ï‡∏±‡∏ß‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô) üéâüéâ")
print("----------------------------------------------------")
# ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡πÄ‡∏õ‡πá‡∏ô 0) ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏î‡∏π‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà Lasso ‡∏Å‡∏±‡∏ö RF ‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
if(length(final_hub_genes) == 0) {
   print("‚ö†Ô∏è (AI 3 ‡∏ï‡∏±‡∏ß‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î‡πÑ‡∏õ ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞‡πÜ)")
   print("üëâ ‡∏¢‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏à‡∏≤‡∏Å LASSO + Random Forest):")
   print(intersect(lasso_gene_names, rf_gene_names))
} else {
   print(final_hub_genes)
}

# (‡πÅ‡∏ñ‡∏°) ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤ SVM ‡πÄ‡∏à‡∏≠‡∏¢‡∏µ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏´‡∏°?
target_check <- c("LILRA1", "CCL20", "IL1R2", "TYROBP", "CXCL16", "NFKBIA")
print("--- ‡πÄ‡∏ä‡πá‡∏Å‡∏¢‡∏µ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô SVM ---")
print(intersect(svm_gene_names, target_check))

# --- ‡∏î‡∏π‡∏¢‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î 2 ‡πÉ‡∏ô 3 (Venn Diagram ‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏°‡πÜ) ---

# ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡πà‡∏•‡∏∞ AI ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
u1 <- union(lasso_gene_names, rf_gene_names)
u2 <- union(u1, svm_gene_names)
all_candidates <- unique(c(lasso_gene_names, rf_gene_names, svm_gene_names))

# ‡∏ô‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏´‡∏ß‡∏ï (Vote Counting)
vote_counts <- data.frame(Gene = all_candidates, Score = 0)

for(g in all_candidates) {
  score <- 0
  if(g %in% lasso_gene_names) score <- score + 1
  if(g %in% rf_gene_names) score <- score + 1
  if(g %in% svm_gene_names) score <- score + 1
  vote_counts[vote_counts$Gene == g, "Score"] <- score
}

# ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 2 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
almost_winners <- vote_counts[vote_counts$Score >= 2, ]
almost_winners <- almost_winners[order(-almost_winners$Score), ]

print("--- ü•à ‡∏¢‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ä‡∏ô‡∏∞ (‡∏ï‡∏¥‡∏î 2 ‡πÉ‡∏ô 3 AI) ---")
print(almost_winners)


# --- 7. Validation: ‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏î‡πâ‡∏ß‡∏¢ ROC Curve ---

# 1. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à pROC (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
if (!require("pROC")) install.packages("pROC")
library(pROC)

# 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î Validation (‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÅ‡∏¢‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ)
val_idx <- grep("validation", clean_data$"cohort:ch1", ignore.case = TRUE)
validation_set <- clean_data[, val_idx]

print(paste("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ä‡∏∏‡∏î Validation:", ncol(validation_set)))

# 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏â‡∏•‡∏¢ (Control vs AMI) ‡∏Ç‡∏≠‡∏á‡∏ä‡∏∏‡∏î Validation
raw_val_groups <- validation_set$"disease_status:ch1"
# ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
clean_val_groups <- gsub("disease_status: ", "", raw_val_groups)
clean_val_groups <- gsub("Myocardial Infarction", "AMI", clean_val_groups, ignore.case = TRUE)

# ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (AMI=1, Control=0)
y_val <- ifelse(clean_val_groups == "AMI", 1, 0)

# 4. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏µ‡∏ô CXCL16 ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö
# ‡∏´‡∏≤ Probe ID ‡∏Ç‡∏≠‡∏á CXCL16 (‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á degs ‡πÄ‡∏î‡∏¥‡∏°)
target_symbol <- "CXCL16"
target_probe <- rownames(degs)[which(degs$Gene.symbol == target_symbol)[1]]

if (is.na(target_probe)) {
  # ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏£‡∏á‡πÜ (‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡∏°‡∏≤)
  target_probe <- "223454_at" 
}

# ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Expression ‡∏Ç‡∏≠‡∏á CXCL16 ‡πÉ‡∏ô‡∏ä‡∏∏‡∏î Validation
x_val_gene <- exprs(validation_set)[target_probe, ]

# 5. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü ROC ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì AUC
roc_obj <- roc(y_val, x_val_gene, ci=TRUE)

# ‡∏û‡∏•‡πá‡∏≠‡∏ï‡∏î‡∏Å‡∏£‡∏≤‡∏ü
plot(roc_obj, 
     main = paste("ROC Curve for", target_symbol, "(Validation Set)"),
     col = "blue", lwd = 3, legacy.axes = TRUE)

# ‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (AUC)
auc_value <- auc(roc_obj)
print("------------------------------------------------")
print(paste("üèÜ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (AUC) ‡∏Ç‡∏≠‡∏á", target_symbol, "‡∏Ñ‡∏∑‡∏≠:", round(auc_value, 4)))
print("------------------------------------------------")

# ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:
# AUC > 0.7 = ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ
# AUC > 0.8 = ‡∏î‡∏µ‡∏°‡∏≤‡∏Å
# AUC > 0.9 = ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° (‡∏£‡∏∞‡∏î‡∏±‡∏ö Biomarker)

# --- Step 7 (Final Assignment): ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏î‡∏ú‡∏• (Accuracy/F1) ---

library(caret)
library(e1071)
library(randomForest)

# 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Train (‡∏ä‡∏∏‡∏î Discovery) ‡πÅ‡∏•‡∏∞ Test (‡∏ä‡∏∏‡∏î Validation)
# ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏¢‡∏µ‡∏ô "CXCL16" ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Ñ‡∏±‡∏î‡∏°‡∏≤‡πÑ‡∏î‡πâ (Hub Gene)
target_gene_symbol <- "CXCL16"
# (‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ ID ‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô: "223454_at")

# ‡∏´‡∏≤ Probe ID
probe_id <- rownames(degs)[which(degs$Gene.symbol == target_gene_symbol)[1]]
if(is.na(probe_id)) probe_id <- "223454_at" # Fallback

# ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Train (Discovery)
x_train <- as.numeric(exprs(discovery_set)[probe_id, ])
y_train <- as.factor(ifelse(grepl("AMI", clean_groups, ignore.case=T), "Sick", "Healthy"))
train_data <- data.frame(Gene = x_train, Class = y_train)

# ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Test (Validation) - ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á
x_test <- as.numeric(exprs(validation_set)[probe_id, ])
# ‡∏ï‡πâ‡∏≠‡∏á clean ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏° Validation ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Train
raw_val_groups <- validation_set$"disease_status:ch1"
clean_val_groups <- gsub("disease_status: ", "", raw_val_groups)
clean_val_groups <- gsub("Myocardial Infarction", "AMI", clean_val_groups, ignore.case = TRUE)

y_test <- as.factor(ifelse(clean_val_groups == "AMI", "Sick", "Healthy"))
test_data <- data.frame(Gene = x_test, Class = y_test)

# --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ô 3 ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ï‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå ---
print("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö 3 ‡πÇ‡∏°‡πÄ‡∏î‡∏• (SVM, Random Forest, GLM)...")

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô (Cross Validation 5 ‡∏£‡∏≠‡∏ö)
ctrl <- trainControl(method = "cv", number = 5, classProbs = TRUE, summaryFunction = twoClassSummary)

# Model 1: SVM
set.seed(123)
model_svm <- train(Class ~ ., data = train_data, method = "svmRadial", 
                   trControl = ctrl, metric = "ROC")
pred_svm <- predict(model_svm, test_data)
cm_svm <- confusionMatrix(pred_svm, test_data$Class, mode = "Prec_Recall")

# Model 2: Random Forest
set.seed(123)
model_rf <- train(Class ~ ., data = train_data, method = "rf", 
                  trControl = ctrl, metric = "ROC")
pred_rf <- predict(model_rf, test_data)
cm_rf <- confusionMatrix(pred_rf, test_data$Class, mode = "Prec_Recall")

# Model 3: Logistic Regression (GLM)
set.seed(123)
model_glm <- train(Class ~ ., data = train_data, method = "glm", family = "binomial",
                   trControl = ctrl, metric = "ROC")
pred_glm <- predict(model_glm, test_data)
cm_glm <- confusionMatrix(pred_glm, test_data$Class, mode = "Prec_Recall")

# --- ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå (‡∏Ç‡πâ‡∏≠ 7) ---
results_table <- data.frame(
  Model = c("SVM", "Random Forest", "Logistic Regression"),
  Accuracy = c(cm_svm$overall["Accuracy"], cm_rf$overall["Accuracy"], cm_glm$overall["Accuracy"]),
  F1_Score = c(cm_svm$byClass["F1"], cm_rf$byClass["F1"], cm_glm$byClass["F1"]),
  Sensitivity = c(cm_svm$byClass["Sensitivity"], cm_rf$byClass["Sensitivity"], cm_glm$byClass["Sensitivity"]),
  Specificity = c(cm_svm$byClass["Specificity"], cm_rf$byClass["Specificity"], cm_glm$byClass["Specificity"])
)

print("-------------------------------------------------------")
print(paste("üèÜ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏¢‡∏µ‡∏ô:", target_gene_symbol))
print("-------------------------------------------------------")
print(results_table)

# Bonus: ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
print("--- ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Extra Score ---")
print(paste("Feature ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ñ‡∏∑‡∏≠:", target_gene_symbol))
print("‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤ Expression ‡∏Ç‡∏≠‡∏á‡∏¢‡∏µ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏Ñ‡∏ô‡∏õ‡πà‡∏ß‡∏¢ (AMI) ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç")